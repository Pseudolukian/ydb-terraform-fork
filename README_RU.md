# Развертывание инфраструктуры с помощью Terraform для инсталляции YDB кластера

Перед скачиванием и использованием готовых сценариев, убедитесь в том, что вам доступно нужное количество инфраструктурных ресурсов, а если вы используете облачные провайдеры – проверьте баланс аккаунта и настройку CLI облачного провайдера. 

Для стабильной работы YDB кластера нужны девять серверов, каждый из которых должен обладать следующими характеристиками: 16 CPU, 16 GB RAM, выделенный диск объёмом не менее 200 GB. Серверы должны иметь сетевую связность, и на них должен быть открыт 22 порт для доступа Ansible по SSH.

## Структура репозитория, настройка и выполнение Terraform сценариев

Репозиторий содержит директории, названия которых соответствуют названиям облачных провайдеров (`yandex_cloud`, `azure`, `aws`). Каждая директория содержит `readme` файлы на русском и английском языках с описанием процессов установки, настройки и запуска сценария. Основной файл – это `main.tf`, он расположен в корневой директории каждого сценария. В нём описаны облачные ресурсы, которые будут созданы после выполнения команды `terraform init`. 

Количество создаваемых ресурсов и их свойства описаны в файле `variables.tf`, который также находится в корневой директории каждого сценария. Файл содержит переменные в следующем формате:
```
variable "<variable name>" {
  description = " ... "
  type        = <variable type (string, number, list, map)>
  default     = <default value>
}
```

Переменные организованы в логические группы, чтобы было проще искать нужные переменные и изменять их значения. Группа `Auth vars control zone` содержит переменные для аутентификации в облаке провайдера, а в группе `VM control vars zone` находятся переменные, которые управляют настройками виртуальных серверов Свойства переменных всех групп описаны в `readme` файлах каждого сценария. Обратите внимание на то, что Terraform сценарии по умолчанию настроены на создание девяти ВМ. Это значение зафиксировано в переменной `vm_count`.

Помимо глобальных переменных (определяют общие настройки инфраструктуры), каждый модуль (поддиректория с файлами расширения `.tf`, которые находятся в директории `modules`) содержит локальные переменные в файле `variables.tf`. Переменные, имеющие опцию `default` устанавливаю локальные значения модуля, а переменные без опции `default` являются транспортными переменными – получают значения от глобальных переменных. 

После установки значения переменных аутентификации и настройки (если она нужна) CLI можно выполнить последовательность команд, находясь в корневой директории сценария:
* `terraform init` – скачивание Terraform провайдера и инициализация модулей.
* `terraform plan` – показать план выполнения сценария и создаваемые ресурсы.
* `terraform init` (повторное применение) – создать облачную инфраструктуру.

Опции подключения к ВМ описаны в `readme` файлах каждого сценария.

## Облачные ресурсы и схема их создания терраформом 

Terraform сценарии (в данном репозитории) реализуют единую схему создания ресурсов:
1. Создаётся облачная сеть, в выбранном регионе.
2. Создаются три подсети в разных зонах доступности региона.
3. Применяются группы безопасности для регулируемого обмена трафиком между ВМ. 
4. Создаются ВМ и подключаются к подсетям.
5. Создаётся DNS приватная зона.