---
# ===========Setup ports forwarding========== 

- name: Resolve FQDN to IP
  command: dig +short {{ hostvars[inventory_hostname]['ansible_fqdn'] }}
  register: fqdn_ip

- name: Enable IP forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: yes
    state: present
    reload: yes

- name: Forward multiple ports to localhost
  iptables:
    table: nat
    chain: PREROUTING
    jump: DNAT
    to_destination: "{{ fqdn_ip.stdout }}:{{ item }}"
    destination: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
    protocol: tcp
    match: tcp
    destination_port: "{{ item }}"
  loop:
    - "{{ ic_port }}"
    - "{{ grpc_port }}"
    - "{{ mon_port }}"