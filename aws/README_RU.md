# Создание инфраструктуры в AWS для развертывания YDB кластера

Для реализации данного Terraform сценария понадобится: AWS аккаунт, AWS CLI, активный платежный аккаунт, достаточное количество средства для запуска 9 виртуальных машин, подготовленные SSH-ключи.

Создать аккаунт в AWS можно по [ссылке](https://console.aws.amazon.com). После создания аккаунт нужно пополнить баланс на сумму достаточную для работы 9 ВМ. Рассчитать стоимость содержания инфраструктуры можно с помощью [калькулятора](https://calculator.aws/#/createCalculator/ec2-enhancement).

Затем нужно создать пользователя и ключ подключения в AWS Cloud для работы AWS CLI:
* Пользователь создаётся в разделе Security credentials → Access management → [Users](https://console.aws.amazon.com/iam/home#/users) → Create User.
* На следующем шаге нужно назначить права пользователю. Выберете `AmazonEC2FullAccess`.
* После создания пользователя – перейдите в него, откройте вкладку `Security credentials` и нажмите кнопку **Create access key** в секции **Access keys**.
* Из предложенных вариантов наборов опций выберете `Command Line Interface`.
* Далее придумайте тег для разметки ключа и нажмите кнопку **Create access key**. 
* Скопируйте значение полей `Access key` и `Secret access key`.

После создания пользователя и ключа доступа можно скачать, и установить [AWS CLI](https://aws.amazon.com/cli/). Далее нужно выполнить команду `aws configure` и ввести значения полей `Access key` и `Secret access key` сохраненные ранее. Осталось отредактировать файлы `~/.aws/credentials` и `~/.aws/config` следующим образом:
* Добавьте `[AWS_def_reg]` в `~/.aws/config` перед `region = ...`.
* Добавьте `[AWS]` перед секретной информацией о ключах подключения.

Теперь можно скачивать репозиторий и задавать актуальные значения переменным. Скачать репозиторий можно командой `git clone https://github.com/ydb-platform/ydb-terraform.git`. Перейдите в директорию `aws`, в скаченном репозитории и отредактируйте следующие переменные в файле `variable.tf`:
* `aws_region` – регион, в котором будет развернута инфраструктура.
* `aws_profile` – имя профиля безопасности из файла `~/.aws/credentials`.
* `availability_zones` – список зон доступности региона. Формируется из названия региона и порядковой буквы. Например, для региона `us-west-2` список зон доступности будет выглядеть так: `["us-west-2a", "us-west-2b", "us-west-2c"]`.

Для создания инфраструктуры в первый раз нужно выполнить последовательность команд:
* `terraform init` – установка провайдера и инициализация модулей.
* `terraform plan` – создание плана будущей инфраструктуры.
* `terraform init` (повторное выполнение) – создание ресурсов в облаке. 

Далее используются команды `terraform plan`, `terraform init` и `terraform destroy` (уничтожение созданной инфраструктуры).

## Значения переменных

Глобальные переменные проекта, содержащие данные для аутентификации, конфигурации виртуальных серверов,  находятся в корневом `variables.tf`, а локальные переменные модулей находятся в `variables.tf`, в каждом модуле. Переменные корневого файла `variables.tf`:

| Название переменной | Описание | Тип | Дефолтное значение | Примечание |
|---------------------|----------|-----|--------------------| ---------- |
| `aws_region` | Регион, в котором будет развернута инфраструктура. | string | <region name> | |
| `aws_profile` | Имя профиля безопасности из файла `~/.aws/credentials`. | string | AWS ||
| `vm_count` | Количество создаваемых ВМ | number | 9 | Минимальное количество машин в YDB кластере должно быть не менее восьми для типа избыточности blok-4-2 и девяти ВМ для типа избыточности morrow-3-dc. |
| `availability_zones` | Список зон доступности региона. | list | ["us-west-2a", "us-west-2b", "us-west-2c"] | Формируется из названия региона и порядковой буквы. Например, для региона `us-west-2` список зон доступности будет выглядеть так: `["us-west-2a", "us-west-2b", "us-west-2c"]`. |
| `subnets_count` | Количество подсетей, которое будет создано в зонах доступности. | number | 3 ||
| `allow_ports_list` | Список портов для которых будет разрешен трафик | list | [21, 22] ||
| `vm_prefix` | Префикс названия ВМ. | string | static-node- ||
| `domain` | Имя домена приватной DNS зоны | string | ydb-cluster.com ||
