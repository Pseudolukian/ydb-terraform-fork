# Создание инфраструктуры в Azure для развертывания YDB кластера

Для реализации данного Terraform сценария понадобится: Azure аккаунт, активный платежный аккаунт, достаточное количество средства для запуска 9 виртуальных машин, Azure CLI для аутентификации в Azure, подготовленные SSH-ключи.

Скачать, установить и настроить Azure CLI можно, следуя [этой](https://learn.microsoft.com/ru-ru/cli/azure/install-azure-cli) инструкции. Авторизоваться в Azure с помощью Azure CLI можно в интерактивном режиме командой `azure login`, а для создания пары SSH-ключей (Linux, macOS) проще всего будет воспользоваться командой `ssh-keygen`.

После авторизации в Azure и генерации SSH-ключей нужно изменить дефолтное значение следующих переменных в корневом файле `variables.tf`:
* `auth_location` – название региона, где будет развернута инфраструктура. Список доступных регионов в зависимости от подписки можно получить командой `az account list-locations | grep "displayName"`.
* `ssh_key_path` – путь к публичной части сгенерированного SSH-ключа.

Значение остальных переменных можно оставить без изменения. Находясь в корневой директории Terraform сценария, выполните команду `terraform init` – будет установлен Terraform провайдер и инициализированы модули. После выполните команду `terraform plan` для создания плана создания инфраструктуры и далее выполните команду `terraform apply` для создания инфраструктуры в облаке Azure.

Будут созданы следующие ресурсы:
* Группа ресурсов (`auth_resource_group_name`) в указанной регионе (`auth_location`).
* Облачная виртуальная сеть с заданным именем (`network_name`). CIDR по умолчанию: 10.0.0.0/16.
* Подсети (`subnets_count`) со следующей логикой выдачи IP: "10.0.N.0/24".
* Группа безопасности, разрешающая трафик на портах: 22, 53, 80.
* Локальная DNS зона с задаваемым именем домена (`domain`).
* Виртуальные серверы с публичными IP и SSH доступом.

Получить список публичных IP адресов виртуальных машин для подключения по SSH можно командой `az vm list-ip-addresses -g dev-rg -n dev-vm`. 

## Значение переменных 

Глобальные переменные проекта, содержащие данные для аутентификации, конфигурации виртуальных серверов,  содержатся в `variables.tf`, в корневой директории проекта.

| Название переменной | Описание | Тип | Дефолтное значение | Примечание |
|---------------------|----------|-----|--------------------| ---------- |
| `auth_location`     | Регион, где будет создана инфраструктура | string | East US | Список доступных регионов можно получить командой `az vm list-ip-addresses -g dev-rg -n dev-vm` |
| `auth_resource_group_name` | Название группы ресурсов | string | ydb-test-group| | 
| `vm_name` | Название ВМ | string | ydb-node | |
| `vm_count` | Количество создаваемых ВМ | number | 3 | Минимальное количество ВМ для развертывания YDB кластера – восемь ВМ|
| `vm_user` | Пользователь для подключения к ВМ по SSH | string | ubuntu | |
| `vm_size` | Стандартная конфигурация ВМ | string | East US | Получить список доступных конфигураций ВМ можно получить командой `az vm list-skus --location <location name> --output table` |
| `network_name` | Название облачной сети | string | ydb-network | |
| `subnets_count` | Количество подсетей, которое будет создано в группе ресурсов | number | 3 | |
| `domain` | Название домена DNS зоны | string | ydb-cluster.com | |